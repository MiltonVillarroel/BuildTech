{% extends 'mantenimiento/base.html' %}

{% block maintenance_content %}
{% if tickets %}
<div class="table-responsive">
    <table class="tickets-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>DescripciÃ³n</th>
                <th>Prioridad</th>
                <th>Responsable</th>
                <th>Fecha Inicio</th>
                <th>Fecha Fin</th>
                <th>Costo</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in tickets %}
            <tr>
                <td><strong>#{{ ticket.id_mantenimiento }}</strong></td>
                <td class="ticket-description">{{ ticket.descripcion }}</td>
                <td>
                    <span class="priority priority-{{ ticket.prioridad|lower }}">
                        {{ ticket.prioridad }}
                    </span>
                </td>
                <td>{{ ticket.responsable or 'âŒ Sin asignar' }}</td>
                <td>{{ ticket.fecha_ini.strftime('%d/%m/%Y') if ticket.fecha_ini else 'â³ Pendiente' }}</td>
                <td>{{ ticket.fecha_fin.strftime('%d/%m/%Y') if ticket.fecha_fin else 'â³ Pendiente' }}</td>
                <td>
                    {% if ticket.costo %}
                        <strong>Bs. {{ '%.2f'|format(ticket.costo) }}</strong>
                    {% else %}
                        <span class="text-muted">Sin estimar</span>
                    {% endif %}
                </td>
                <td>
                    {% if ticket.trabajo_realizado %}
                        <span class="status status-completed">âœ… Completado</span>
                    {% elif ticket.fecha_ini %}
                        <span class="status status-in-progress">ğŸ”„ En progreso</span>
                    {% else %}
                        <span class="status status-pending">â³ Pendiente</span>
                    {% endif %}
                </td>
                <td class="actions">
                    {% if current_user.has_role('admin') %}
                        {% if not ticket.responsable %}
                            <a href="{{ url_for('mantenimiento.update_ticket_ini', id=ticket.id_mantenimiento) }}" 
                               class="btn btn-sm btn-primary" title="Iniciar mantenimiento">
                                ğŸš€ Iniciar
                            </a>
                        {% elif not ticket.trabajo_realizado %}
                            <a href="{{ url_for('mantenimiento.update_ticket_fin', id=ticket.id_mantenimiento) }}" 
                               class="btn btn-sm btn-success" title="Finalizar mantenimiento">
                                âœ… Finalizar
                            </a>
                        {% endif %}
                    {% endif %}
                    
                    <a href="{{ url_for('comunicacion.chat_ticket', ticket_id=ticket.id_mantenimiento) }}" 
                       class="btn btn-sm btn-info" title="Chat del ticket">
                        ğŸ’¬ Chat
                    </a>
                    
                    <a href="{{ url_for('mantenimiento.generate_ticket', id=ticket.id_mantenimiento) }}" 
                       class="btn btn-sm btn-info" title="Ver detalles">
                        ğŸ‘ï¸ Ver
                    </a>
                    
                    {% if current_user.has_role('admin') %}
                        <form method="POST" 
                              action="{{ url_for('mantenimiento.delete_ticket', id=ticket.id_mantenimiento) }}" 
                              style="display:inline;" 
                              onsubmit="return confirm('Â¿EstÃ¡ seguro de eliminar este ticket?');">
                            <button type="submit" class="btn btn-sm btn-danger" title="Eliminar ticket">
                                ğŸ—‘ï¸ Eliminar
                            </button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="no-tickets">
    <div class="empty-state">
        <span class="empty-icon">ğŸ“‹</span>
        <h3>No hay tickets de mantenimiento</h3>
        <p>Los tickets creados aparecerÃ¡n aquÃ­</p>
        <a href="{{ url_for('mantenimiento.create_ticket') }}" class="btn btn-primary">
            â• Crear Primer Ticket
        </a>
    </div>
</div>
{% endif %}

<style>
.table-responsive {
    overflow-x: auto;
    margin-top: 1rem;
}

.actions {
    white-space: nowrap;
    min-width: 300px;
}

.actions .btn {
    margin: 2px;
}

@media (max-width: 768px) {
    .tickets-table {
        font-size: 0.85rem;
    }
    
    .actions {
        min-width: auto;
    }
    
    .actions .btn {
        display: block;
        width: 100%;
        margin: 5px 0;
    }
}
</style>
{% endblock %}