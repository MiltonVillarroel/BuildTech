{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h2>üí∞ Resumen Financiero - {{ mes_actual }}</h2>
        <div class="header-actions">
            <a href="{{ url_for('finanzas.gestionar_gastos') }}" class="btn btn-warning">
                üí∏ Gestionar Gastos
            </a>
            <button onclick="generarReporte()" class="btn btn-info">
                üìä Generar Reporte PDF
            </button>
        </div>
    </div>
    
    <!-- Tarjetas de Estad√≠sticas -->
    <div class="stats-grid">
        <div class="stat-card stat-income">
            <div class="stat-icon">üíµ</div>
            <div class="stat-content">
                <h3>Ingresos del Mes</h3>
                <div class="stat-value">Bs. {{ "%.2f"|format(total_ingresos) }}</div>
                <small>Cargos: Bs. {{ "%.2f"|format(ingresos_cargos) }} | Reservas: Bs. {{ "%.2f"|format(ingresos_reservas) }}</small>
            </div>
        </div>
        
        <div class="stat-card stat-expense">
            <div class="stat-icon">üí∏</div>
            <div class="stat-content">
                <h3>Gastos del Mes</h3>
                <div class="stat-value">Bs. {{ "%.2f"|format(total_gastos) }}</div>
                <small>{{ gastos_mes|length }} gastos registrados</small>
            </div>
        </div>
        
        <div class="stat-card {% if balance >= 0 %}stat-positive{% else %}stat-negative{% endif %}">
            <div class="stat-icon">{% if balance >= 0 %}üìà{% else %}üìâ{% endif %}</div>
            <div class="stat-content">
                <h3>Balance</h3>
                <div class="stat-value">Bs. {{ "%.2f"|format(balance) }}</div>
                <small>Ingresos - Gastos</small>
            </div>
        </div>
        
        <div class="stat-card stat-pending">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-content">
                <h3>Pendientes</h3>
                <div class="stat-value">Bs. {{ "%.2f"|format(total_pendiente_cargos + total_pendiente_reservas) }}</div>
                <small>Por cobrar</small>
            </div>
        </div>
    </div>
    
    <!-- Informaci√≥n Adicional -->
    <div class="info-grid mt-4">
        <div class="info-card">
            <h4>üìä Estad√≠sticas Generales</h4>
            <div class="info-row">
                <span>Total Departamentos:</span>
                <strong>{{ total_departamentos }}</strong>
            </div>
            <div class="info-row">
                <span>Tasa de Morosidad:</span>
                <strong class="{% if tasa_morosidad > 30 %}text-danger{% elif tasa_morosidad > 15 %}text-warning{% else %}text-success{% endif %}">
                    {{ tasa_morosidad }}%
                </strong>
            </div>
            <div class="info-row">
                <span>Ingreso Proyectado:</span>
                <strong>Bs. {{ "%.2f"|format(ingreso_proyectado) }}</strong>
            </div>
        </div>
        
        <div class="info-card">
            <h4>üè∑Ô∏è Gastos por Categor√≠a</h4>
            {% for categoria, monto in gastos_por_categoria.items() %}
            <div class="info-row">
                <span>{{ categoria|title }}:</span>
                <strong>Bs. {{ "%.2f"|format(monto) }}</strong>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Tabs de Contenido -->
    <div class="tabs-container mt-4">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#cargos">
                    üìã Cargos Pendientes ({{ cargos_pendientes|length }})
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#reservas">
                    üé´ Reservas Pendientes ({{ pagos_reservas_pendientes|length }})
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#gastos">
                    üí∏ Gastos del Mes ({{ gastos_mes|length }})
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#historial">
                    üìú Historial Reciente
                </a>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- Cargos Pendientes -->
            <div id="cargos" class="tab-pane active">
                {% if cargos_pendientes %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Dpto</th>
                                <th>Per√≠odo</th>
                                <th>Luz</th>
                                <th>Agua</th>
                                <th>Gas</th>
                                <th>Mantenimiento</th>
                                <th>Expensas</th>
                                <th>Total</th>
                                <th>Vencimiento</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cargo in cargos_pendientes %}
                            <tr class="{% if cargo.esta_vencido %}table-warning{% endif %}">
                                <td><strong>{{ cargo.departamento }}</strong></td>
                                <td>{{ cargo.mes_nombre }} {{ cargo.anio }}</td>
                                <td>Bs. {{ "%.2f"|format(cargo.luz) }}</td>
                                <td>Bs. {{ "%.2f"|format(cargo.agua) }}</td>
                                <td>Bs. {{ "%.2f"|format(cargo.gas) }}</td>
                                <td>Bs. {{ "%.2f"|format(cargo.mantenimiento) }}</td>
                                <td>Bs. {{ "%.2f"|format(cargo.expensas_comunes) }}</td>
                                <td><strong>Bs. {{ "%.2f"|format(cargo.total) }}</strong></td>
                                <td>
                                    {{ cargo.fecha_vencimiento.strftime('%d/%m/%Y') if cargo.fecha_vencimiento else 'N/A' }}
                                    {% if cargo.esta_vencido %}
                                        <br><span class="badge bg-danger">{{ cargo.dias_vencido }} d√≠as vencido</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="POST" action="{{ url_for('finanzas.pagar_pendiente', tipo_pago='cargo', pk=cargo.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            ‚úì Marcar Pagado
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-primary">
                                <td colspan="7"><strong>TOTAL PENDIENTE:</strong></td>
                                <td colspan="3"><strong>Bs. {{ "%.2f"|format(total_pendiente_cargos) }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <p class="mb-0">‚úÖ No hay cargos mensuales pendientes</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Reservas Pendientes -->
            <div id="reservas" class="tab-pane">
                {% if pagos_reservas_pendientes %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Reserva #</th>
                                <th>Monto</th>
                                <th>Fecha</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pago in pagos_reservas_pendientes %}
                            <tr>
                                <td>#{{ pago.reserva_id }}</td>
                                <td><strong>Bs. {{ "%.2f"|format(pago.monto) }}</strong></td>
                                <td>{{ pago.fecha_generacion.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('finanzas.pagar_pendiente', tipo_pago='reserva', pk=pago.id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            ‚úì Marcar Pagado
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-primary">
                                <td><strong>TOTAL:</strong></td>
                                <td colspan="3"><strong>Bs. {{ "%.2f"|format(total_pendiente_reservas) }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <p class="mb-0">‚úÖ No hay pagos de reservas pendientes</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Gastos del Mes -->
            <div id="gastos" class="tab-pane">
                {% if gastos_mes %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Concepto</th>
                                <th>Categor√≠a</th>
                                <th>Monto</th>
                                <th>Registrado por</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gasto in gastos_mes %}
                            <tr>
                                <td>{{ gasto.fecha_gasto.strftime('%d/%m/%Y') }}</td>
                                <td>{{ gasto.concepto }}</td>
                                <td><span class="badge bg-secondary">{{ gasto.categoria }}</span></td>
                                <td><strong>Bs. {{ "%.2f"|format(gasto.monto) }}</strong></td>
                                <td>{{ gasto.registrado_por }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-danger">
                                <td colspan="3"><strong>TOTAL GASTOS:</strong></td>
                                <td colspan="2"><strong>Bs. {{ "%.2f"|format(total_gastos) }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <p class="mb-0">‚ÑπÔ∏è No hay gastos registrados este mes</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Historial Reciente -->
            <div id="historial" class="tab-pane">
                {% if historial_reciente %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Dpto</th>
                                <th>Monto</th>
                                <th>M√©todo</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hist in historial_reciente %}
                            <tr>
                                <td>{{ hist.fecha_pago.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td><span class="badge bg-primary">{{ hist.tipo_pago }}</span></td>
                                <td>{{ hist.departamento }}</td>
                                <td><strong>Bs. {{ "%.2f"|format(hist.monto) }}</strong></td>
                                <td>{{ hist.metodo_pago|title }}</td>
                                <td><small>{{ hist.observaciones or 'N/A' }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <p class="mb-0">‚ÑπÔ∏è No hay pagos registrados</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function generarReporte() {
    const hoy = new Date();
    const mes = hoy.getMonth() + 1;
    const anio = hoy.getFullYear();
    window.location.href = `/financiera/reporte_mensual/${mes}/${anio}/`;
}
</script>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    font-size: 3rem;
}

.stat-content h3 {
    font-size: 0.9rem;
    color: #666;
    margin: 0 0 0.5rem 0;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    margin: 0.5rem 0;
}

.stat-income { border-left: 4px solid #27ae60; }
.stat-expense { border-left: 4px solid #e74c3c; }
.stat-positive { border-left: 4px solid #3498db; }
.stat-negative { border-left: 4px solid #e67e22; }
.stat-pending { border-left: 4px solid #f39c12; }

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.info-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.info-card h4 {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e0e0e0;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f0f0f0;
}

.tabs-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.tab-content {
    padding: 2rem 0;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .header-actions {
        flex-direction: column;
    }
}
</style>

<!-- Bootstrap JS para tabs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}